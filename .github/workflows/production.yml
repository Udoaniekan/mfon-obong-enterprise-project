# ===========================================
# PRODUCTION Deployment Workflow
# ===========================================
# Triggers: Push to 'production' branch
# Deploys to: DigitalOcean or AWS (to be configured)

name: Deploy to Production

# When to run this workflow
on:
  push:
    branches:
      - production    # ONLY run on production branch

# Environment variables
env:
  DOCKER_IMAGE: udoaniekan/mfon-obong-enterprise

jobs:
  # ===========================================
  # JOB 1: Run Tests & Build
  # ===========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Run tests
        run: npm run test --if-present

      - name: Build application
        run: npm run build

  # ===========================================
  # JOB 2: Build & Push Docker Image
  # ===========================================
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:production
            ${{ env.DOCKER_IMAGE }}:production-${{ github.sha }}
            ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # JOB 3: Deploy to Production Server
  # ===========================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production    # Use 'production' environment secrets

    steps:
      - name: Deployment Summary
        run: |
          echo "========================================"
          echo "ðŸš€ PRODUCTION DEPLOYMENT"
          echo "========================================"
          echo "Image: ${{ env.DOCKER_IMAGE }}:production"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "========================================"

      # ==========================================
      # OPTION A: DigitalOcean Deployment
      # Uncomment below when you set up DigitalOcean
      # ==========================================
      # - name: Install doctl (DigitalOcean CLI)
      #   uses: digitalocean/action-doctl@v2
      #   with:
      #     token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      #
      # - name: Deploy to DigitalOcean App Platform
      #   run: |
      #     doctl apps create-deployment ${{ secrets.DIGITALOCEAN_APP_ID }}

      # ==========================================
      # OPTION B: AWS ECS Deployment
      # Uncomment below when you set up AWS
      # ==========================================
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: us-east-1
      #
      # - name: Deploy to AWS ECS
      #   run: |
      #     aws ecs update-service --cluster your-cluster --service your-service --force-new-deployment

      - name: Production Deployment Notice
        run: |
          echo "========================================"
          echo "âœ… Docker image pushed successfully!"
          echo ""
          echo "ðŸ“‹ NEXT STEPS:"
          echo "1. Choose your cloud provider (DigitalOcean or AWS)"
          echo "2. Create 'production' environment in GitHub"
          echo "3. Add required secrets to production environment"
          echo "4. Uncomment the deployment section above"
          echo "========================================"
